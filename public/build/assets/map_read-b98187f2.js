import{m as ne}from"./mapConfig-a03dedb3.js";import{s as oe,t as G}from"./functions-5aea6087.js";import{g as ie,a as J,d as N,e as ae,u as Q}from"./api-e53b87f9.js";import{S as se,P as ce,W as le,M as re,O as de,B as me,a as ge,A as V}from"./OBJLoader-c0df76fe.js";let l,v,B,C,r;async function pe(){const f=await ie();let k=await J("footprints",f);if(!k){const y={id:f,rights_write:1,rights_read:0};await create("footprints",y),k=await J("footprints",f)}v=new se,B=new ce(75,window.innerWidth/window.innerHeight,.1,1e3),C=new le({alpha:!0}),C.setSize(window.innerWidth,window.innerHeight),document.getElementById("3d-model").appendChild(C.domElement),B.position.z=9,B.position.y+=1;let X=new re,A=new de;X.load("models/ducks/Duck.mtl",function(y){y.preload(),A.setMaterials(y),A.load("models/ducks/Duck.obj",function(x){r=x,r.scale.set(.2,.2,.2);const S=new me().setFromObject(r),_=S.max.y-S.min.y;r.position.y=_/2,r.rotation.y=Math.PI,r.rotation.x+=ge.degToRad(25);const L=new V(16777215,1);v.add(L);const $=new V(16448210,1);v.add($),v.add(r)})});function O(){requestAnimationFrame(O),C.render(v,B)}O();async function Y(){const{Map:y}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:x,PinElement:S}=await google.maps.importLibrary("marker"),{PlacesService:_,PlacesServiceStatus:L,RankBy:$}=await google.maps.importLibrary("places");let F=[],H=[];navigator.geolocation.getCurrentPosition(async function(D){let h={lat:D.coords.latitude,lng:D.coords.longitude},q=0;window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(o){o.alpha!==null&&(q=o.alpha)},!1),l=new y(document.getElementById("map"),ne(h,q));const M=document.createElement("img");M.src="img/duckpin.svg",M.style.width="52px",M.style.height="148px",new x({map:l,content:M,position:h,zIndex:999});const T=250;let j=new google.maps.Circle({strokeColor:"#db8555",strokeOpacity:.8,strokeWeight:3,fillColor:"#f8c967",fillOpacity:.15,map:l,center:h,radius:T});const Z={北:90,東:180,南:270,西:0};function ee(o,E,a){const g=(E-90)*Math.PI/180,d=a/111325,m=d/Math.cos(o.lat*Math.PI/180);return{lat:o.lat+d*Math.cos(g),lng:o.lng+m*Math.sin(g)}}for(const[o,E]of Object.entries(Z)){const a=ee(h,E,T),g=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" font-size="24" font-weight="bold" stroke="#f8c967" stroke-width="1" fill="#db8555" fill-opacity="0.8">${o}</text></svg>`;new google.maps.Marker({position:a,map:l,icon:{url:"data:image/svg+xml,"+encodeURIComponent(g),scaledSize:new google.maps.Size(22,22)}})}const z=new _(l),U={location:h,rankBy:$.DISTANCE,type:["park"]};let W=[],b={};z.nearbySearch(U,(o,E)=>{if(E===L.OK){for(let a=0;a<o.length;a++){let K=function(t){const i=["北","北東","東","南東","南","南西","西","北西"],n=Math.round(((t%=360)<0?t+360:t)/45)%8;return i[n]};if(!o[a].types.some(t=>U.type.includes(t))||W.includes(o[a].place_id))continue;W.push(o[a].place_id);let g=google.maps.geometry.spherical.computeDistanceBetween(o[a].geometry.location,j.getCenter())<=j.getRadius();const d=document.createElement("img");d.src="img/palebottole.png",d.style.width="40px",d.style.height="80px";const m=new x({map:l,content:d,position:o[a].geometry.location});m.placeId=o[a].place_id,b[m.placeId]=m,m.addListener("click",()=>{const t=document.querySelector(`.card[data-place-id="${m.placeId}"]`),i=document.querySelector("#cards-slider"),n=t.offsetLeft-i.offsetWidth/2+t.offsetWidth/2;i.scrollTo({left:n,behavior:"smooth"})});let e=new Promise((t,i)=>{z.getDetails({placeId:m.placeId},(n,p)=>{if(p===L.OK){const s=n.formatted_address.split(",").slice(0,-2).join(",").trim(),I=Math.floor(google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(h),n.geometry.location)),u=google.maps.geometry.spherical.computeHeading(new google.maps.LatLng(h),n.geometry.location),c=K(u);H.push({placeId:n.place_id,name:n.name,nickname:"みかいたくのち",address:s,latitude:n.geometry.location.lat(),longitude:n.geometry.location.lng(),distance:I+"m",direction:c,photoURL:n.photos?n.photos[0].getUrl():"/img/type-park.png",isInCircle:g}),t()}else i()})});F.push(e)}Promise.all(F).then(async()=>{H.sort((e,t)=>parseInt(e.distance)-parseInt(t.distance)),document.querySelector("#cards-slider").innerHTML="";const a=await N("spots"),g=await N("messages");for(const e of H){const t=e.placeId,i=a.find(u=>u.gmpid===t),n=(i==null?void 0:i.name)||"みかいたくのち",p=i==null?void 0:i.id;let w=0,s=!1;if(i){const u=g.filter(c=>c.spot_id===p);if(w=u?u.filter(c=>c.status==="投下済み"&&c.writer_id!==f).length:0,s=e.isInCircle&&k.rights_read>=1&&w>=1,s){const c=b[t];if(c){c.setMap(null);const P=document.createElement("img");P.src="img/kirabottle.png",P.style.width="40px",P.style.height="80px";const te=new x({map:l,content:P,position:c.position});b[t]=te}}}const I={...e,nickname:n,msgCount:w,isPickable:s};d(I),await oe(100)}function d(e){const t=`<div style="background-color: ${e.isInCircle?"#FFFFFF":"#E5E7EB"}" class="card flex-none w-64 h-48 mr-4 mb-4 rounded-xl shadow-lg flex flex-col justify-between" data-place-id="${e.placeId}">
                                            <img src="${e.photoURL}" class="w-full h-2/5 object-cover rounded-t-xl scale">
                                            <div class="p-3 scale">
                                                <p class="text-xs text-gray-500">${G(e.name,12)} - ${e.direction} ${e.distance}</p>
                                                <h2 class="text-base text-gray-700 font-semibold">${G(e.nickname,12)}</h2>
                                                <p class="text-xs text-gray-400">${e.msgCount}件あります</p>
                                            </div>
                                            <button data-place-id="${e.placeId}" style="background-color: ${e.isPickable?"#1E2082":"#6A7280"}" class="${e.isPickable?"pickup-button":"not-pickup-button"} p-3 text-sm text-white rounded-b-xl" ${e.isPickable?"":"disabled"}>ここのひみつをひろう</button>
                                        </div>`;document.querySelector("#cards-slider").innerHTML+=t}document.querySelectorAll(".card .scale").forEach(e=>{e.addEventListener("click",()=>{const t=b[e.closest(".card").dataset.placeId];t.content.style.transform="scale(1.5)"})}),google.maps.event.addListener(l,"click",()=>{for(let e in b)b[e].content.style.transform="scale(1.0)"}),document.querySelectorAll(".pickup-button").forEach(e=>{e.addEventListener("click",async t=>{const i=t.target.getAttribute("data-place-id"),n=a.find(s=>s.gmpid===i);let p=await ae("messages","spot_id",n.id);p=p.filter(s=>s.status==="投下済み"&&s.writer_id!==f);const w=p.length;if(w<=0||k.rights_read<=0)document.getElementById("myModal").classList.remove("hidden");else{const s=Math.floor(Math.random()*w),I=p[s];let u={...I,reader_id:f,status:"収得済み"};await Q("messages",I.id,u);let c={...k,rights_read:0};await Q("footprints",f,c),window.location.href="/reading_view"}})})})}})})}async function R(){document.getElementById("rotate-right").disabled=!0,document.getElementById("rotate-left").disabled=!0,document.getElementById("reload").disabled=!0,await Y(),document.getElementById("rotate-right").disabled=!1,document.getElementById("rotate-left").disabled=!1,document.getElementById("reload").disabled=!1}R(),document.getElementById("rotate-left").addEventListener("click",function(){l.setHeading(l.getHeading()-45),r.rotation.y-=Math.PI/4}),document.getElementById("rotate-right").addEventListener("click",function(){l.setHeading(l.getHeading()+45),r.rotation.y+=Math.PI/4}),document.getElementById("reload").addEventListener("click",async function(){await R(),r.rotation.y=Math.PI})}pe();
