import{m as it}from"./mapConfig-a03dedb3.js";import{s as at,t as K,n as st}from"./functions-5aea6087.js";import{g as lt,a as N,c as G,d as J,b as Q,u as V}from"./api-03a3d816.js";import{S as ct,P as dt,W as rt,M as mt,O as gt,B as pt,a as ut,A as X}from"./OBJLoader-c0df76fe.js";let l,b,B,M,d;async function ft(){const u=await lt();let k=await N("footprints",u);k||(await G("footprints",{id:u,rights_write:1,rights_read:0}),k=await N("footprints",u)),b=new ct,B=new dt(75,window.innerWidth/window.innerHeight,.1,1e3),M=new rt({alpha:!0}),M.setSize(window.innerWidth,window.innerHeight),document.getElementById("3d-model").appendChild(M.domElement),B.position.z=9,B.position.y+=1;let Y=new mt,A=new gt;Y.load("models/ducks/Duck.mtl",function(f){f.preload(),A.setMaterials(f),A.load("models/ducks/Duck.obj",function(x){d=x,d.scale.set(.2,.2,.2);const S=new pt().setFromObject(d),P=S.max.y-S.min.y;d.position.y=P/2,d.rotation.y=Math.PI,d.rotation.x+=ut.degToRad(25);const E=new X(16777215,1);b.add(E);const C=new X(16448210,1);b.add(C),b.add(d)})});function O(){requestAnimationFrame(O),M.render(b,B)}O();async function Z(){const{Map:f}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:x,PinElement:S}=await google.maps.importLibrary("marker"),{PlacesService:P,PlacesServiceStatus:E,RankBy:C}=await google.maps.importLibrary("places");let H=[],$=[];navigator.geolocation.getCurrentPosition(async function(R){let p={lat:R.coords.latitude,lng:R.coords.longitude},q=0;window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(i){i.alpha!==null&&(q=i.alpha)},!1),l=new f(document.getElementById("map"),it(p,q));const L=document.createElement("img");L.src="img/duckpin.svg",L.style.width="52px",L.style.height="148px",new x({map:l,content:L,position:p,zIndex:999});const D=250;let j=new google.maps.Circle({strokeColor:"#db8555",strokeOpacity:.8,strokeWeight:3,fillColor:"#f8c967",fillOpacity:.15,map:l,center:p,radius:D});const tt={北:90,東:180,南:270,西:0};function et(i,w,a){const r=(w-90)*Math.PI/180,m=a/111325,g=m/Math.cos(i.lat*Math.PI/180);return{lat:i.lat+m*Math.cos(r),lng:i.lng+g*Math.sin(r)}}for(const[i,w]of Object.entries(tt)){const a=et(p,w,D),r=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" font-size="24" font-weight="bold" stroke="#f8c967" stroke-width="1" fill="#db8555" fill-opacity="0.8">${i}</text></svg>`;new google.maps.Marker({position:a,map:l,icon:{url:"data:image/svg+xml,"+encodeURIComponent(r),scaledSize:new google.maps.Size(22,22)}})}const z=new P(l),T={location:p,rankBy:C.DISTANCE,type:["park"]};let W=[],v={};z.nearbySearch(T,(i,w)=>{if(w===E.OK){for(let a=0;a<i.length;a++){let U=function(e){const n=["北","北東","東","南東","南","南西","西","北西"],o=Math.round(((e%=360)<0?e+360:e)/45)%8;return n[o]};if(!i[a].types.some(e=>T.type.includes(e))||W.includes(i[a].place_id))continue;W.push(i[a].place_id);let r=google.maps.geometry.spherical.computeDistanceBetween(i[a].geometry.location,j.getCenter())<=j.getRadius();const m=document.createElement("img");m.src=r?"img/kirabottle.png":"img/palebottole.png",m.style.width="40px",m.style.height="80px";const g=new x({map:l,content:m,position:i[a].geometry.location});g.placeId=i[a].place_id,v[g.placeId]=g,g.addListener("click",()=>{const e=document.querySelector(`.card[data-place-id="${g.placeId}"]`),n=document.querySelector("#cards-slider"),o=e.offsetLeft-n.offsetWidth/2+e.offsetWidth/2;n.scrollTo({left:o,behavior:"smooth"})});let t=new Promise((e,n)=>{z.getDetails({placeId:g.placeId},(o,h)=>{if(h===E.OK){const I=o.formatted_address.split(",").slice(0,-2).join(",").trim(),c=Math.floor(google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(p),o.geometry.location)),s=google.maps.geometry.spherical.computeHeading(new google.maps.LatLng(p),o.geometry.location),F=U(s);$.push({placeId:o.place_id,name:o.name,nickname:"みかいたくのち",address:I,latitude:o.geometry.location.lat(),longitude:o.geometry.location.lng(),distance:c+"m",direction:F,photoURL:o.photos?o.photos[0].getUrl():"/img/type-park.png",isInCircle:r}),e()}else n()})});H.push(t)}Promise.all(H).then(async()=>{$.sort((t,e)=>parseInt(t.distance)-parseInt(e.distance)),document.querySelector("#cards-slider").innerHTML="";const a=await J("spots"),r=await J("messages");for(const t of $){const e=t.placeId,n=a.find(c=>c.gmpid===e),o=(n==null?void 0:n.name)||"みかいたくのち",h=n==null?void 0:n.id;let y=0;if(n){const c=r.filter(s=>s.spot_id===h);y=c?c.filter(s=>s.status==="投下済み"&&s.writer_id!==u).length:0}const I={...t,nickname:o,msgCount:y};m(I),await at(100)}function m(t){document.querySelector("#cards-slider").innerHTML+=`<div style="background-color: ${t.isInCircle?"#FFFFFF":"#E5E7EB"}" class="card flex-none w-64 h-48 mr-4 mb-4 rounded-xl shadow-lg flex flex-col justify-between" data-place-id="${t.placeId}">
                                <img src="${t.photoURL}" class="w-full h-2/5 object-cover rounded-t-xl scale">
                                <div class="p-3 scale">
                                    <p class="text-xs text-gray-500">${K(t.name,12)} - ${t.direction} ${t.distance}</p>
                                    <h2 class="text-base text-gray-700 font-semibold">${K(t.nickname,12)}</h2>
                                    <p class="text-xs text-gray-400">${t.msgCount}件あります</p>
                                </div>
                                <button data-place-id="${t.placeId}" data-place-lat="${t.latitude}" data-place-lng="${t.longitude}" style="background-color: ${t.isInCircle?"#1E2082":"#6A7280"}" class="${t.isInCircle?"pickup-button":"not-pickup-button"} p-3 text-sm text-white rounded-b-xl" ${t.isInCircle?"":"disabled"}>ここに秘密をなげる</button>
                            </div>`}document.querySelectorAll(".card .scale").forEach(t=>{t.addEventListener("click",()=>{const e=v[t.closest(".card").dataset.placeId];e.content.style.transform="scale(1.5)"})}),google.maps.event.addListener(l,"click",()=>{for(let t in v)v[t].content.style.transform="scale(1.0)"}),document.querySelectorAll(".pickup-button").forEach(t=>{t.addEventListener("click",async e=>{const n=e.target.getAttribute("data-place-id"),o=e.target.getAttribute("data-place-lat"),h=e.target.getAttribute("data-place-lng"),y=parseFloat(o).toFixed(6),I=parseFloat(h).toFixed(6),c=await Q("messages","writer_id",u);if(c.status=="下書き"){let s=await Q("spots","gmpid",n);if(!s){const ot={type:"park",gmpid:n,name:st(),latitude:y,longitude:I};s=await G("spots",ot)}let F={...c,status:"投下済み",spot_id:s.id};await V("messages",c.id,F);let nt={...k,rights_read:1};await V("footprints",k.id,nt),window.location.href="/throwing"}else document.getElementById("myModal").classList.remove("hidden")})})})}})})}async function _(){document.getElementById("rotate-right").disabled=!0,document.getElementById("rotate-left").disabled=!0,document.getElementById("reload").disabled=!0,await Z(),document.getElementById("rotate-right").disabled=!1,document.getElementById("rotate-left").disabled=!1,document.getElementById("reload").disabled=!1}_(),document.getElementById("rotate-left").addEventListener("click",function(){l.setHeading(l.getHeading()-45),d.rotation.y-=Math.PI/4}),document.getElementById("rotate-right").addEventListener("click",function(){l.setHeading(l.getHeading()+45),d.rotation.y+=Math.PI/4}),document.getElementById("reload").addEventListener("click",async function(){await _(),d.rotation.y=Math.PI})}ft();
